name: Automatic Backup of Documentation

# این ورک‌فلو با هر push به master که شامل تغییر در پوشه viraai/docs باشد، اجرا می‌شود.
on:
  push:
    branches:
      - master
    paths:
      - 'viraai/docs/**'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      # ۱. تنظیم کلید SSH برای دسترسی به مخزن خصوصی
      - name: Setup SSH Key for Backup Repository
        uses: webfactory/ssh-agent@v0.5.4
        with:
          # کلید خصوصی که شما در Secrets ذخیره کرده‌اید
          ssh-private-key: ${{ secrets.BACKUP_SSH_KEY }}
          
      # ۲. Checkout کردن محتوای مخزن فعلی
      - name: Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ۳. کپی محتوای docs به دایرکتوری موقت
      - name: Copy Docs Content to Temporary Directory
        run: |
          mkdir -p /tmp/docs_to_push
          cp -R viraai/docs/. /tmp/docs_to_push

      # ۴. Push نهایی با استفاده از SSH
      - name: Commit and Push to Destination Repository (SSH)
        run: |
          # تنظیمات Git برای کامیت
          git config --global user.email "backup-bot@viraaiio.com"
          git config --global user.name "ViraAI Backup Bot"
          
          # رفتن به دایرکتوری محتوای کپی شده
          cd /tmp/docs_to_push
          
          # تنظیم remote با استفاده از پروتکل SSH (که از کلید بالا استفاده می‌کند)
          git init
          git remote add backup-repo git@github.com:viraaiio/viraai-backup.git
          
          # کشیدن آخرین تغییرات مخزن مقصد
          git pull backup-repo master || echo "Initial pull failed, continuing..."

          # اضافه کردن فایل‌ها
          git add .
          
          # کامیت کردن تغییرات
          git commit -m "Automated documentation backup [skip ci]" || echo "No changes to commit."

          # Push اجباری به شاخه master مخزن مقصد
          # Force push برای اطمینان از همگام‌سازی کامل محتوای docs
          git push -u backup-repo master --force

      - name: Verification Log
        if: success()
        run: echo "Backup completed successfully using SSH Deploy Key."
