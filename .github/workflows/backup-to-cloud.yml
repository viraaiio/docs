# ุงู Workflow ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุชุบุฑุงุช ุฏุฑ ูพูุดู viraaiio/docs ุฑุง ุงุฒ ูุฎุฒู docs
# ุจู ูุฎุฒู ุฎุตูุต viraai-cloud-project ุณูฺฉ (Push) ูโฺฉูุฏ.

name: Document Sync to Cloud Project

on:
  push:
    branches:
      - main # ุง masterุ ุจุฑ ุงุณุงุณ ูุงู ุจุฑูฺ ุงุตู ุดูุง
    paths:
      - 'viraaiio/docs/**' # ููุท ุฏุฑ ุตูุฑุช ุชุบุฑ ุฏุฑ ุงู ูุณุฑ ูุนุงู ุดูุฏ

jobs:
  sync_docs:
    runs-on: ubuntu-latest
    
    # ูุชุบุฑูุง ูุญุท ุจุฑุง ุณุงุฏฺฏ
    env:
      TARGET_REPO: viraaiio/viraai-cloud-project
      TARGET_BRANCH: master # ุจุฑูฺ ููุตุฏ (ุจุฑ ุงุณุงุณ ุชุตุงูุฑ ุดูุง master ุงุณุช)
      SOURCE_PATH: viraaiio/docs
      TARGET_DIR: target_repo
      
    steps:
      # 1. Checkout ูุฎุฒู ุงุตู (docs) ฺฉู ุชุฑฺฏุฑ ุดุฏู ุงุณุช
      # ุจุฑุง ูุฎุฒู ูุจุฏุงุ ุงุฒ ุชูฺฉู ูพุดโูุฑุถ (GITHUB_TOKEN) ุงุณุชูุงุฏู ูโฺฉูู ฺฉู ฺฉุงู ุงุณุช.
      - name: Checkout Source Repository (viraaiio/docs)
        uses: actions/checkout@v4
        with:
          path: source_repo

      # 2. ฺฉููู ฺฉุฑุฏู ูุฎุฒู ููุตุฏ (viraai-cloud-project) ุจุง ุงุณุชูุงุฏู ุงุฒ PAT Token
      - name: Clone Target Repository with PAT Token
        run: |
          # ุณุงุฎุช URL ฺฉููู ุดุงูู PAT Token
          # ุงู ุฑูุด ุชุถูู ูโฺฉูุฏ ฺฉู PAT Token ุจุฑุง ุฏุณุชุฑุณ ุจู ูุฎุฒู ุฎุตูุต ุงุณุชูุงุฏู ุดูุฏ.
          CLONE_URL="https://${{ secrets.PAT_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git"
          
          # ุงุฌุฑุง ุฏุณุชูุฑ ฺฉููู
          git clone --branch ${{ env.TARGET_BRANCH }} --single-branch $CLONE_URL ${{ env.TARGET_DIR }}
          
      # 3. ฺฉูพ ู ุณูฺฉ ูุงูโูุง
      - name: Copy & Sync files from Docs to Cloud Project Subdir
        run: |
          # ุงุฌุงุฏ ุฏุงุฑฺฉุชูุฑ ููุตุฏ ุฏุฑ ุฏุงุฎู ูุฎุฒู ฺฉููู ุดุฏู
          mkdir -p ${{ env.TARGET_DIR }}/${{ env.SOURCE_PATH }}
          
          # ฺฉูพ ฺฉุฑุฏู ุชูุงู ูุญุชูุงุช ูพูุดู docs ุงุฒ source ุจู target
          # rsync -a: ุญุงูุช ุขุฑุดู (ุญูุธ ูุฌูุฒูุงุ ุฒูุงูโูุง ู ...)
          # --delete: ูุงูโูุง ฺฉู ุฏุฑ ูุจุฏุง ุญุฐู ุดุฏูโุงูุฏ ุฑุง ุฏุฑ ููุตุฏ ูุฒ ุญุฐู ูโฺฉูุฏ (ุณูฺฉ ูุงูุน)
          rsync -av --exclude='.git' --delete source_repo/${{ env.SOURCE_PATH }}/ ${{ env.TARGET_DIR }}/${{ env.SOURCE_PATH }}/

      # 4. ุชูุธูุงุช Git ุจุฑุง Push ุฎูุฏฺฉุงุฑ
      - name: Configure Git for Auto-Commit
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          
      # 5. Commit ู Push ุชุบุฑุงุช ุจู ูุฎุฒู ููุตุฏ
      - name: Commit and Push Changes to Target Repo
        run: |
          cd ${{ env.TARGET_DIR }}
          git add .
          
          # ุจุฑุฑุณ ูโฺฉูู ุขุง ุชุบุฑ ุจุฑุง Commit ูุฌูุฏ ุฏุงุฑุฏ ุง ูู
          if git diff --cached --exit-code; then
            echo "No changes to commit. Skipping push."
          else
            git commit -m "๐ค [Docs Sync] Automatic documentation update from viraaiio/docs"
            
            # ุงุณุชูุงุฏู ุงุฒ ุชูฺฉู PAT ุจุฑุง Push:
            # ุชูฺฉู ุฑุง ุฏุฑ URL ูุฑุงุฑ ูโุฏูู ุชุง ุฏุณุชุฑุณ ุจู ูุฎุฒู ุฎุตูุต ููุตุฏ ุฑุง ุฏุงุดุชู ุจุงุดุฏ.
            git push origin ${{ env.TARGET_BRANCH }}
          fi
