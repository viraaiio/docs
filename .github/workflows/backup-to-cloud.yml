name: Backup Docs

on:
  push:
    branches:
      - master

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write # <--- این خط جدید است!
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: docs
          
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          repository: viraaiio/viraai-cloud-project
          token: ${{ secrets.PAT_FOR_BACKUP }} # Now using PAT with write access
          path: target_repo
          
      - name: Copy Docs to Target Repo Directory
        run: |
          mkdir -p target_repo/viraaiio/docs
          # Use rsync for better copying/syncing logic, but cp -R is also fine for now
          cp -R docs/. target_repo/viraaiio/docs/

      - name: Commit and Push Changes to Target Repo
        run: |
          cd target_repo
          # We need to use the token from the secret in the push URL, 
          # but since you are using `actions/checkout` with the token, 
          # the local Git history in the target_repo path should be set up correctly for push.
          
          # Let's ensure the push URL uses the PAT explicitly for maximum certainty,
          # as the error suggests the default setup for push is failing authentication.
          
          # The problem is that the `actions/checkout` with `token: ${{ secrets.PAT_FOR_BACKUP }}` 
          # correctly fetches the repo, but the final `git push` uses the default token 
          # if the PAT is not embedded in the remote URL.
          
          # We will modify the `git push` command to use the token explicitly:
          
          git config user.name "viraaiio[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add viraaiio/docs
          git commit -m "Automated backup of viraaiio/docs" || echo "No changes to commit"
          
          # Pushing using the token directly in the URL (THIS IS THE KEY CHANGE)
          git push https://${{ secrets.PAT_FOR_BACKUP }}@github.com/viraaiio/viraai-cloud-project.git HEAD:master 
          # Note: We are using HEAD:master to ensure we push the current commit to the master branch.
