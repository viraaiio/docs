name: Backup Docs

on:
  push:
    branches:
      - master

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    # توجه: این مجوز مورد نیاز نیست چون از PAT_FOR_BACKUP استفاده می‌کنیم.
    # اما اگر PAT به هر دلیلی کار نکرد، استفاده از GITHUB_TOKEN پیش‌فرض به همراه این مجوز ضروری است.
    # برای اطمینان از کارکرد با PAT، این خط را حذف یا کامنت می‌کنیم.
    # permissions:
    #   contents: write 

    steps:
      - name: Checkout Source Repo (viraaiio/docs)
        uses: actions/checkout@v4
        with:
          path: docs # Checkout into 'docs' directory
          
      # گام Checkout مخزن مقصد به این روش (فقط برای دریافت محتوا) باید حفظ شود.
      - name: Checkout Target Repo (viraaiio/viraai-cloud-project)
        uses: actions/checkout@v4
        with:
          repository: viraaiio/viraai-cloud-project
          token: ${{ secrets.PAT_FOR_BACKUP }}
          path: target_repo # Checkout into 'target_repo' directory
          
      - name: Copy Docs to Target Repo Directory
        run: |
          # ساخت پوشه هدف در مخزن مقصد
          mkdir -p target_repo/viraaiio/docs
          # کپی کردن محتوای docs به پوشه جدید در target_repo
          # از علامت نقطه (`.`) در انتها استفاده می‌کنیم تا مطمئن شویم محتویات کپی شوند، نه خود پوشه docs.
          cp -R docs/. target_repo/viraaiio/docs/

      # گام نهایی و قطعی: Push با استفاده از PAT و بدون درگیر شدن با تنظیمات داخلی Git
      - name: Commit and Push Changes to Target Repo
        run: |
          cd target_repo
          git config user.name "viraaiio[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add viraaiio/docs
          
          # اجرای commit
          git commit -m "Automated backup of viraaiio/docs" || echo "No changes to commit"

          # Push با استفاده از PAT به عنوان رمز عبور (این روش امن و استاندارد است)
          git push https://x-access-token:${{ secrets.PAT_FOR_BACKUP }}@github.com/viraaiio/viraai-cloud-project.git
